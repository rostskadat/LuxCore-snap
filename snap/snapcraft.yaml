name: luxcore
base: core22
adopt-info: luxcore
issues: https://github.com/rostskadat/LuxCore-snap/issues
website: https://luxcorerender.org/
summary: A physically based and unbiased rendering engine
description: |
  LuxCoreRender is a physically based and unbiased rendering engine. Based on
  state of the art algorithms, LuxCoreRender simulates the flow of light 
  according to physical equations, thus producing realistic images of 
  photographic quality.

  Commands:
    luxcore.luxcoreui: Run luxcoreui
    luxcore.luxcoreconsole: Run luxcoreconsole

grade: devel
confinement: strict
compression: lzo
license: LGPL-2.0-or-later

layout:
  /usr/share/X11:
    symlink: $SNAP/kf5/usr/share/X11
  /usr/share/libdrm/amdgpu.ids:
    bind-file: $SNAP/kf5/usr/share/libdrm/amdgpu.ids
  /usr/bin/mpirun: # ElmerSolver_mpi
    symlink: $SNAP/usr/bin/orterun
  /usr/share/openmpi:
    symlink: $SNAP/usr/share/openmpi
  /etc/openmpi:
    bind: $SNAP/etc/openmpi
  /usr/lib/$CRAFT_ARCH_TRIPLET/openmpi:
    bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/openmpi
  /usr/bin/orted:
    symlink: $SNAP/usr/bin/orted
  /usr/share/pmix:
    symlink: $SNAP/usr/share/pmix
  /usr/lib/$CRAFT_ARCH_TRIPLET/pmix:
    symlink: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/pmix
  /etc/matplotlibrc:
    bind-file: $SNAP/etc/matplotlibrc
  /usr/share/matplotlib:
    symlink: $SNAP/usr/share/matplotlib
  /usr/share/qt5:
    symlink: $SNAP/kf5/usr/share/qt5
  /usr/bin/dot: # Graphviz for dependency graph
    symlink: $SNAP/usr/bin/dot
  /usr/bin/unflatten: # Graphviz for dependency graph
    symlink: $SNAP/usr/bin/unflatten
  /usr/share/povray-3.7: # Raytracing
    symlink: $SNAP/usr/share/povray-3.7
    
plugs:
  # this is not used or needed for anything other than to trigger automatic
  # installation of the cups snap via "default-provider: cups"
  foo-install-cups:
    interface: content
    content: foo
    default-provider: cups
    target: $SNAP_DATA/foo
  # Necessary to enable semaphores for numba, OpenMP etc.
  shared-memory:
    private: true
  # QT5 libs
  kf5-5-108-qt-5-15-10-core22:
    content: kf5-5-108-qt-5-15-10-core22-all
    interface: content
    default-provider: kf5-5-108-qt-5-15-10-core22
    target: $SNAP/kf5

environment:
  LD_LIBRARY_PATH: "$SNAP/usr/lib/:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/:$SNAP/kf5/usr/lib/$CRAFT_ARCH_TRIPLET/:$SNAP/kf5/usr/lib:/$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/blas:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/lapack:$LD_LIBRARY_PATH"
  LD_PRELOAD: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/libstubchown.so
  FREECAD_USER_HOME: $SNAP_USER_COMMON
  GIT_EXEC_PATH: $SNAP/usr/lib/git-core
  GIT_TEMPLATE_DIR: $SNAP/usr/share/git-core/templates
  GIT_CONFIG_NOSYSTEM: 1
  ELMER_HOME: $SNAP/usr
  QTWEBENGINE_DISABLE_SANDBOX: 1
  PYTHONPYCACHEPREFIX: $SNAP_USER_COMMON/.pycache
  PYTHONUSERBASE: $SNAP_USER_COMMON/.local
  PIP_USER: 1
  PYTHONPATH: &pypath $PYTHONUSERBASE/lib/python3.10/site-packages:$SNAP/lib/python3.10/site-packages:$SNAP/usr/lib/python3/dist-packages
  SNAP_PYTHONPATH: *pypath
  QT_QPA_PLATFORM: xcb # Coin3D cannot run on Wayland
  POVINI: $SNAP/etc/povray/3.7/povray.ini # Raytracing

apps:
  luxcoreui:
    command: usr/bin/luxcoreui
    extensions: 
      - kde-neon
    common-id: org.luxcore.LuxCoreUI.desktop
    desktop: usr/share/applications/org.luxcore.LuxCoreUI.desktop
    plugs: &plugs
      - home
      - opengl
      - removable-media
      - gsettings
      - network      
      - browser-support
      - unity7
      - cups
      - shared-memory
    command-chain:
      - snap/command-chain/desktop-launch
  luxcoreconsole:
    command: usr/bin/luxcoreconsole
    extensions: [kde-neon]
    plugs: *plugs

package-repositories:
  - type: apt
    ppa: elmer-csc-ubuntu/elmer-csc-ppa
  - type: apt
    components:
      - main
    suites:
      - jammy
    key-id: 444DABCF3667D0283F894EDDE6D4736255751E5D
    url: http://origin.archive.neon.kde.org/user
    key-server: keyserver.ubuntu.com

parts:
  stub-chown:
    plugin: meson
    source: $CRAFT_PROJECT_DIR/snap/local/stub-chown
    source-type: local
    build-packages:
    - meson
    meson-parameters:
      - --prefix=/usr

  snap-setup-mod:
    plugin: dump
    source: $CRAFT_PROJECT_DIR/snap/local/snap-setup-mod
    source-type: local
    organize:
      "*": usr/Mod/SnapSetup/

  oidin:
  #   source: https://github.com/OpenImageDenoise/oidn.git
  # Download: https://github.com/OpenImageDenoise/oidn/releases/download/v2.1.0/oidn-2.1.0.x86_64.linux.tar.gz
    plugin: dump
    source: https://github.com/OpenImageDenoise/oidn/releases/download/v2.1.0/oidn-2.1.0.x86_64.linux.tar.gz
    source-type: tar

  # https://wiki.luxcorerender.org/Compiling_LuxCore#Linux
  luxcore:
    plugin: cmake
    source: https://github.com/LuxCoreRender/LuxCore.git
    cmake-parameters:
      - -DCMAKE_PREFIX_PATH=/usr/lib/$CRAFT_ARCH_TRIPLET:/usr/include/$CRAFT_ARCH_TRIPLET
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DCMAKE_BUILD_TYPE=Release
      - -DOIDN_INCLUDE_PATH=/root/parts/oidin/src/include
      - -DOIDN_LIBRARY=/root/parts/oidin/src/lib
      - -DPYTHON_EXECUTABLE=/usr/bin/python3
      - -DPYTHON_INCLUDE_DIR=/usr/include/python3.10
      - -DPYTHON_LIBRARY=/usr/lib/$CRAFT_ARCH_TRIPLET/libpython3.10.so
    build-packages:
      - git 
      - g++ 
      - flex 
      - bison
      - libbz2-dev 
      - libopenimageio-dev 
      - libtiff5-dev 
      - libpng-dev
      - libgtk-3-dev 
      - libopenexr-dev
      - libopenvdb-dev
      - libgl1-mesa-dev 
      - python3-dev 
      - python3-pip
      - libboost-all-dev
      - libembree-dev
    stage-packages:
      - libembree3-3
      - libopenvdb8.1
      - python3-willow
      - python3-pyside2uic

  # python-packages:
  #   plugin: python
  #   source: .
  #   source-type: local
  #   build-packages:
  #     - libsuitesparse-dev
  #   stage-packages:
  #     - python3-distutils # pip
  #     - libamd2 # scikit-sparse
  #     - libcamd2 # scikit-sparse
  #     - libccolamd2 # scikit-sparse
  #     - libcholmod3 # scikit-sparse
  #     - libcolamd2 # scikit-sparse
  #     - libsuitesparseconfig5 # scikit-sparse
  #   python-packages:
  #     - pip
  #     - scikit-sparse
  #   stage:
  #     - -pyvenv.cfg
  #     - -lib/python3.10/site-packages/scipy*
  #     - -lib/python3.10/site-packages/numpy*

  # graphviz:
  #   plugin: nil
  #   build-packages:
  #     - graphviz
  #   stage-packages:
  #     - graphviz
  #   override-build: |
  #     dot -c
  #     cp \
  #       /usr/lib/${CRAFT_ARCH_TRIPLET}/graphviz/config* \
  #       ${CRAFT_PART_INSTALL}/usr/lib/${CRAFT_ARCH_TRIPLET}/graphviz/

  # cleanup:
  #   after: [stub-chown, luxcore, python-packages, snap-setup-mod, graphviz]
  #   plugin: nil
  #   build-snaps: [kf5-5-108-qt-5-15-10-core22-sdk]
  #   override-prime: |
  #     set -eux
  #     for snap in "kf5-5-108-qt-5-15-10-core22-sdk"; do  # List all content-snaps you're using here
  #       cd "/snap/$snap/current" && find . -type f,l -exec rm -f "$CRAFT_PRIME/{}" "$CRAFT_PRIME/usr/{}" \;
  #     done
  #     for cruft in bug lintian man; do
  #       rm -rf $CRAFT_PRIME/usr/share/$cruft
  #     done
  #     find $CRAFT_PRIME/usr/share/doc/ -type f -not -name 'copyright' -delete
  #     find $CRAFT_PRIME/usr/share -type d -empty -delete
  #     find $CRAFT_PRIME/usr/lib -type f,l \
  #       -name 'libQt*.so*' `# remove all Qt libs pulled in from Ubuntu repos` \
  #       -not -name 'libQt5Gamepad.so*' -delete `# for OpenSCAD`
