name: luxcore
base: core20
#adopt-info: luxcore
version: 0.0.1
issues: https://github.com/rostskadat/LuxCore-snap/issues
website: https://luxcorerender.org/
summary: A physically based and unbiased rendering engine
description: |
  LuxCoreRender is a physically based and unbiased rendering engine. Based on
  state of the art algorithms, LuxCoreRender simulates the flow of light 
  according to physical equations, thus producing realistic images of 
  photographic quality.

  Commands:
    luxcore.luxcoreui: Run luxcoreui
    luxcore.luxcoreconsole: Run luxcoreconsole

grade: devel
confinement: strict
compression: lzo
license: LGPL-2.0-or-later

# layout:
#   /usr/share/X11:
#     symlink: $SNAP/kf5/usr/share/X11
#   /usr/share/libdrm/amdgpu.ids:
#     bind-file: $SNAP/kf5/usr/share/libdrm/amdgpu.ids
#   /usr/bin/mpirun: # ElmerSolver_mpi
#     symlink: $SNAP/usr/bin/orterun
#   /usr/share/openmpi:
#     symlink: $SNAP/usr/share/openmpi
#   /etc/openmpi:
#     bind: $SNAP/etc/openmpi
#   /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/openmpi:
#     bind: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/openmpi
#   /usr/bin/orted:
#     symlink: $SNAP/usr/bin/orted
#   /usr/share/pmix:
#     symlink: $SNAP/usr/share/pmix
#   /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pmix:
#     symlink: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pmix
#   /etc/matplotlibrc:
#     bind-file: $SNAP/etc/matplotlibrc
#   /usr/share/matplotlib:
#     symlink: $SNAP/usr/share/matplotlib
#   /usr/share/qt5:
#     symlink: $SNAP/kf5/usr/share/qt5
#   /usr/bin/dot: # Graphviz for dependency graph
#     symlink: $SNAP/usr/bin/dot
#   /usr/bin/unflatten: # Graphviz for dependency graph
#     symlink: $SNAP/usr/bin/unflatten
#   /usr/share/povray-3.7: # Raytracing
#     symlink: $SNAP/usr/share/povray-3.7

environment:
  LD_LIBRARY_PATH: "$SNAP/usr/lib/:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/:$LD_LIBRARY_PATH"
  GIT_EXEC_PATH: $SNAP/usr/lib/git-core
  GIT_TEMPLATE_DIR: $SNAP/usr/share/git-core/templates
  GIT_CONFIG_NOSYSTEM: 1
  PIP_USER: 1
#  PYTHONPATH: &pypath $PYTHONUSERBASE/lib/python3.10/site-packages:$SNAP/lib/python3.10/site-packages:$SNAP/usr/lib/python3/dist-packages
#  SNAP_PYTHONPATH: *pypath

apps:
  luxcoreui:
    command: usr/bin/luxcoreui
    plugs: &plugs
      - opengl
  luxcoreconsole:
    command: usr/bin/luxcoreconsole
    plugs: *plugs

parts:

  oidin:
    plugin: dump
    source: https://github.com/OpenImageDenoise/oidn/releases/download/v2.1.0/oidn-2.1.0.x86_64.linux.tar.gz
    source-type: tar

  # https://wiki.luxcorerender.org/Compiling_LuxCore#Linux
  luxcore:
    plugin: cmake
    source: https://github.com/LuxCoreRender/LuxCore.git
    cmake-parameters:
      - -DCMAKE_CXX_FLAGS_INIT="-fPIC" # Required for lib/pyluxcore.so
      - -DCMAKE_C_FLAGS_INIT="-fPIC" # Required for lib/pyluxcore.so
      - -DCMAKE_EXE_LINKER_FLAGS_INIT="-fPIC" # Required for lib/pyluxcore.so
      - -DCMAKE_PREFIX_PATH=/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:/usr/include/$SNAPCRAFT_ARCH_TRIPLET
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DCMAKE_BUILD_TYPE=Release
      - -DOIDN_INCLUDE_PATH=/root/parts/oidin/src/include
      - -DOIDN_LIBRARY=/root/parts/oidin/src/lib/libOpenImageDenoise.so
      # - -DBOOST_ALL_NO_LIB # To link to .so instead of .a
      # - -DBoost_USE_STATIC_LIBS=OFF
      - -DPYTHON_EXECUTABLE=/usr/bin/python3
      - -DPYTHON_INCLUDE_DIR=/usr/include/python3.8
      - -DPYTHON_LIBRARY=/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libpython3.8.so
    build-packages:
      - bison
      - flex
      - g++
      - git
      - libblosc-dev
      - libboost-all-dev # Required
      - libbz2-dev
      - libembree-dev # Required
      - libgl1-mesa-dev
      - libgtk-3-dev
      - libopencolorio-dev
      - libopenexr-dev # Required
      - libopenimageio-dev
      # - libopenvdb-dev
      - libpng-dev
      - libtbb-dev # Required / libtbb2-dev
      - libtiff5-dev
      - python3-dev
      - python3-pip
    stage-packages:
      - libblosc1
      - libembree3-3
      - libopencolorio1v5
      - libopenexr24 # libopenexr25
      - libopenvdb6.2 # libopenvdb8.1
      - libtbb2
      - python3-pyopencolorio
    override-pull: |
      snapcraftctl pull
      # No failure as it might have already been applied...
      # patch --forward --directory=/ --strip=0 --input=$SNAPCRAFT_PROJECT_DIR/snap/local/patches/patch_001.patch || true
      patch --forward --directory=/ --strip=0 --input=$SNAPCRAFT_PROJECT_DIR/snap/local/patches/patch_002.patch || true
      patch --forward --directory=/ --strip=0 --input=$SNAPCRAFT_PROJECT_DIR/snap/local/patches/patch_003.patch || true
